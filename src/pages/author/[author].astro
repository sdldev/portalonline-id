---
import { render } from "astro:content";
import { getCollection } from "../../utils/collections";
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";

export const prerender = true;

export async function getStaticPaths() {
    const authors = await getCollection("author");

    const allContent = [
        ...(await getCollection("tutorial")),
        ...(await getCollection("article")),
        ...(await getCollection("tips")),
        ...(await getCollection("update")),
    ];

    return authors.map((author) => {
        const authorContent = allContent.filter(
            (item) => item.data.author === author.data.name,
        );
        return {
            params: { author: author.id },
            props: { authorProfile: author, content: authorContent },
        };
    });
}

const { authorProfile, content } = Astro.props;
const { Content } = await render(authorProfile);

content.sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);
---

<Layout
    title={`${authorProfile.data.name} | Portal Online`}
    description={`Profil dan daftar tulisan dari ${authorProfile.data.name} di Portal Online.`}
>
    <Navbar />

    <main class="author-page">
        <!-- Hero -->
        <section class="author-hero">
            <div class="container">
                <!-- Breadcrumb -->
                <nav aria-label="Breadcrumb" class="author-breadcrumb">
                    <a href="/">Beranda</a>
                    <span aria-hidden="true">›</span>
                    <a href="/author">Penulis</a>
                    <span aria-hidden="true">›</span>
                    <span aria-current="page">{authorProfile.data.name}</span>
                </nav>

                <!-- Author Profile Card -->
                <div class="author-card">
                    <div class="author-avatar-ring">
                        <img
                            src={authorProfile.data.avatar ||
                                `https://ui-avatars.com/api/?name=${encodeURIComponent(authorProfile.data.name)}&background=random`}
                            alt={authorProfile.data.name}
                            class="author-avatar-img"
                            width="90"
                            height="90"
                        />
                    </div>
                    <div class="author-meta">
                        <span class="badge">✍️ Penulis</span>
                        <h1 class="author-name font-display">
                            <span class="text-gradient"
                                >{authorProfile.data.name}</span
                            >
                        </h1>
                        <p class="author-count">
                            {content.length} artikel dipublikasikan
                        </p>
                        <p class="author-bio"><Content /></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Article List -->
        <section class="author-articles">
            <div class="container">
                {
                    content.length === 0 ? (
                        <p class="empty-msg">
                            Belum ada artikel yang dipublikasikan oleh penulis
                            ini.
                        </p>
                    ) : (
                        <div class="art-list">
                            {content.map((item) => (
                                <a
                                    href={`/${item.collection}/${item.id}`}
                                    class="art-item"
                                >
                                    <div class="art-meta">
                                        <span class="art-cat">
                                            {item.data.category}
                                        </span>
                                        <span class="art-dot">·</span>
                                        <time class="art-date">
                                            {new Date(
                                                item.data.date,
                                            ).toLocaleDateString("id-ID", {
                                                year: "numeric",
                                                month: "short",
                                                day: "numeric",
                                            })}
                                        </time>
                                    </div>
                                    <h2 class="art-title">{item.data.title}</h2>
                                    {item.data.description && (
                                        <p class="art-desc">
                                            {item.data.description}
                                        </p>
                                    )}
                                    {item.data.tags &&
                                        item.data.tags.length > 0 && (
                                            <div class="art-tags">
                                                {item.data.tags
                                                    .slice(0, 5)
                                                    .map((t: string) => (
                                                        <span class="art-tag">
                                                            #{t}
                                                        </span>
                                                    ))}
                                            </div>
                                        )}
                                </a>
                            ))}
                        </div>
                    )
                }
            </div>
        </section>
    </main>

    <Footer />
</Layout>

<style>
    .author-page {
        padding-top: 6rem;
    }

    /* Hero */
    .author-hero {
        padding: 3rem 0 2rem;
        border-bottom: 1px solid var(--color-border);
    }

    /* Breadcrumb */
    .author-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        flex-wrap: wrap;
        font-size: 0.8125rem;
        color: var(--color-text-subtle);
        margin-bottom: 2rem;
    }
    .author-breadcrumb a {
        color: var(--color-text-muted);
        text-decoration: none;
        transition: color var(--transition-fast);
    }
    .author-breadcrumb a:hover {
        color: rgb(var(--color-primary));
    }
    .author-breadcrumb [aria-current="page"] {
        color: var(--color-text);
        font-weight: 600;
    }

    /* Author Card */
    .author-card {
        display: flex;
        align-items: flex-start;
        gap: 1.75rem;
    }

    @media (max-width: 640px) {
        .author-card {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
    }

    .author-avatar-ring {
        flex-shrink: 0;
        width: 90px;
        height: 90px;
        border-radius: 50%;
        padding: 3px;
        background: linear-gradient(
            135deg,
            rgba(var(--color-primary), 0.7),
            rgba(var(--color-secondary), 0.7)
        );
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .author-avatar-img {
        display: block;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .author-meta {
        flex: 1;
        min-width: 0;
    }

    .author-meta .badge {
        margin-bottom: 0.5rem;
        display: inline-block;
    }

    .author-name {
        font-size: clamp(1.5rem, 4vw, 2.25rem);
        font-weight: 800;
        line-height: 1.2;
        margin: 0.25rem 0 0.3rem;
    }

    .author-count {
        font-size: 0.9rem;
        color: var(--color-text-subtle);
        margin: 0 0 0.75rem;
    }

    .author-bio {
        font-size: 0.9375rem;
        color: var(--color-text-muted);
        line-height: 1.7;
        margin: 0;
        max-width: 600px;
    }

    /* Articles */
    .author-articles {
        padding: 2rem 0 4rem;
    }

    .empty-msg {
        text-align: center;
        color: var(--color-text-muted);
        padding: 4rem 0;
    }

    .art-list {
        display: flex;
        flex-direction: column;
    }

    .art-item {
        display: block;
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--color-border);
        text-decoration: none;
    }
    .art-item:last-child {
        border-bottom: none;
    }
    .art-item:hover .art-title {
        color: rgb(var(--color-primary));
    }

    .art-meta {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.8125rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .art-cat {
        color: rgb(var(--color-primary));
        font-weight: 600;
    }
    .art-dot {
        color: var(--color-border);
    }
    .art-date {
        color: var(--color-text-subtle);
    }

    .art-title {
        font-size: 1.125rem;
        font-weight: 700;
        line-height: 1.4;
        color: var(--color-text);
        margin: 0 0 0.375rem;
        transition: color var(--transition-fast);
    }

    @media (min-width: 768px) {
        .art-title {
            font-size: 1.25rem;
        }
    }

    .art-desc {
        font-size: 0.9375rem;
        color: var(--color-text-muted);
        line-height: 1.6;
        margin: 0 0 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .art-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .art-tag {
        font-size: 0.75rem;
        color: var(--color-text-subtle);
    }
</style>
