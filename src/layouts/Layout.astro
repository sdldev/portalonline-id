---
import { SEO } from "astro-seo";
import { ClientRouter } from "astro:transitions";
import ChatWidget from "../components/ChatWidget.astro";
import "../styles/global.css";

export interface Props {
    title?: string;
    description?: string;
    image?: string;
    canonical?: string;
    noindex?: boolean;
    openGraph?: {
        basic: {
            title: string;
            type: string;
            image: string;
            url?: string;
        };
        optional?: {
            description?: string;
            locale?: string;
            siteName?: string;
        };
        article?: {
            publishedTime?: string;
            modifiedTime?: string;
            authors?: string[];
            section?: string;
            tags?: string[];
        };
        image?: {
            url?: string;
            secureUrl?: string;
            type?: string;
            width?: number;
            height?: number;
            alt?: string;
        };
    };
    twitter?: {
        card?: "summary" | "summary_large_image" | "app" | "player";
        site?: string;
        creator?: string;
    };
}

const {
    title = "Portal Online | Berita Terkini & Terpercaya",
    description = "Portal berita online terkini dengan beragam kategori, breaking news, dan konten multimedia. Dapatkan informasi terpercaya dari sumber kredibel.",
    image = "https://portalonline.id/og-default.png",
    canonical = Astro.url.href,
    noindex = false,
    openGraph,
    twitter,
} = Astro.props;

const siteUrl = Astro.site?.href ?? "https://portalonline.id";
---

<!doctype html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Force HTTPS for all resources -->
        <meta
            http-equiv="Content-Security-Policy"
            content="upgrade-insecure-requests"
        />

        <!-- Preload navbar logo for FCP/LCP -->
        <link
            rel="preload"
            href="/portalonline-sm.webp"
            as="image"
            type="image/webp"
        />

        <!-- astro-seo: handles title, description, canonical, OG, Twitter -->
        <SEO
            title={title}
            description={description}
            canonical={canonical}
            noindex={noindex}
            nofollow={noindex}
            openGraph={openGraph ?? {
                basic: {
                    title: title,
                    type: "website",
                    image: image,
                    url: canonical,
                },
                optional: {
                    description: description,
                    locale: "id_ID",
                    siteName: "Portal Online",
                },
                image: {
                    alt: title,
                },
            }}
            twitter={twitter ?? {
                card: "summary_large_image",
                site: "@portalonlineid",
            }}
            extend={{
                link: [
                    { rel: "icon", href: "/favicon.ico", sizes: "48x48" },
                    {
                        rel: "icon",
                        type: "image/svg+xml",
                        href: "/favicon.svg",
                    },
                    { rel: "apple-touch-icon", href: "/apple-touch-icon.png" },
                    { rel: "manifest", href: "/site.webmanifest" },
                    { rel: "preconnect", href: "https://fonts.googleapis.com" },
                    {
                        rel: "preconnect",
                        href: "https://fonts.gstatic.com",
                        crossorigin: "",
                    },
                    {
                        rel: "stylesheet",
                        href: "https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;700&display=swap",
                    },
                ],
                meta: [
                    { name: "theme-color", content: "#f59e0b" },
                    { name: "twitter:image", content: image },
                    { name: "twitter:image:alt", content: title },
                ],
            }}
        />

        <!-- View Transitions -->
        <ClientRouter />
    </head>
    <body>
        <!-- Scanline Transition Overlay -->
        <div class="transition-scanline" id="transition-scanline"></div>

        <slot />

        <!-- WhatsApp Chat Widget -->
        <ChatWidget />

        <style is:global>
            .fixed {
                position: fixed;
            }
            .inset-0 {
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
            }
            .pointer-events-none {
                pointer-events: none;
            }
            .overflow-hidden {
                overflow: hidden;
            }

            /* Scanline Transition Overlay */
            .transition-scanline {
                position: fixed;
                left: 0;
                right: 0;
                top: -100%;
                height: 150px;
                z-index: 9999;
                pointer-events: none;
                background: linear-gradient(
                    to bottom,
                    transparent,
                    rgba(245, 158, 11, 0.3),
                    transparent
                );
                backdrop-filter: brightness(1.5);
                -webkit-backdrop-filter: brightness(1.5);
            }

            .transition-scanline.active {
                animation: scanline-sweep 0.8s ease-in-out forwards;
            }

            @keyframes scanline-sweep {
                0% {
                    top: -100%;
                }
                100% {
                    top: 100%;
                }
            }

            /* View Transitions - Custom Animations */
            /* Old page animation (exit) */
            ::view-transition-old(root) {
                animation: page-exit 0.4s cubic-bezier(0.22, 1, 0.36, 1)
                    forwards;
            }

            /* New page animation (enter) */
            ::view-transition-new(root) {
                animation: page-enter 0.5s cubic-bezier(0.22, 1, 0.36, 1)
                    forwards;
            }

            @keyframes page-exit {
                0% {
                    opacity: 1;
                    transform: scale(1);
                    filter: blur(0px);
                }
                100% {
                    opacity: 0;
                    transform: scale(1.05);
                    filter: blur(15px);
                }
            }

            @keyframes page-enter {
                0% {
                    opacity: 0;
                    transform: scale(0.96);
                    filter: blur(15px);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                    filter: blur(0px);
                }
            }

            /* Ensure smooth transition group for content */
            main {
                view-transition-name: main-content;
            }

            ::view-transition-old(main-content) {
                animation: page-exit 0.4s cubic-bezier(0.22, 1, 0.36, 1)
                    forwards;
            }

            ::view-transition-new(main-content) {
                animation: page-enter 0.5s cubic-bezier(0.22, 1, 0.36, 1)
                    forwards;
            }
        </style>

        <script>
            // Trigger scanline effect on page navigation
            document.addEventListener("astro:before-swap", () => {
                const scanline = document.getElementById("transition-scanline");
                if (scanline) {
                    scanline.classList.remove("active");
                    // Force reflow
                    void scanline.offsetWidth;
                    scanline.classList.add("active");
                }
            });

            // Scroll to top on navigation
            document.addEventListener("astro:after-swap", () => {
                window.scrollTo({ top: 0, behavior: "instant" });
            });

            // Clean up scanline after animation
            document.addEventListener("astro:page-load", () => {
                const scanline = document.getElementById("transition-scanline");
                if (scanline) {
                    setTimeout(() => {
                        scanline.classList.remove("active");
                    }, 800);
                }
            });
        </script>
    </body>
</html>
