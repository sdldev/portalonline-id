---
const testimonials = [
    {
        name: "Zainal Asikin",
        role: "PIMRED SWM (Jurnalis Madya AJI)",
        avatar: "/images/testimoni/zainal-asikin.avif",
        content:
            "Portal Online mengubah cara kami mengelola berita. Setup cepat, dashboard intuitif, dan SEO-nya luar biasa. Traffic kami naik 150% dalam 3 bulan!",
        rating: 5,
    },
    {
        name: "Iskandar Yuan",
        role: "Pimpinan Rasionalis",
        avatar: "/images/testimoni/iskandar-yuan.avif",
        content:
            "Tim redaksi kami sangat terbantu dengan fitur workflow approval. Kolaborasi jadi lebih efisien dan kualitas artikel meningkat signifikan.",
        rating: 5,
    },
    {
        name: "Ridwan Saleh, S.H.",
        role: "Pimpinan Jasaku.co.id",
        avatar: "/images/testimoni/ridwan-saleh-sh.avif",
        content:
            "Selama hampir 5 tahun saya mencari developer yang bukan hanya bisa membuat website, tapi juga bisa diajak komunikasi dengan nyaman. Banyak yang secara teknis pintar, tapi terasa kaku, sulit memahami kebutuhan bisnis, dan hanya mengeksekusi perintah tanpa benar-benar mengerti tujuan klien. Padahal bagi saya, website itu bukan sekadar tampilan — melainkan alat untuk mencapai hasil. Akhirnya saya menemukan Portal Online, dan di sini saya merasa berbeda. Mereka tidak langsung bicara soal fitur atau harga, tapi justru menggali dulu: website ini mau dipakai untuk apa, target marketnya siapa, dan hasil apa yang ingin dicapai. Dari situ saya sadar mereka bukan sekadar jasa pembuatan website, melainkan partner yang memahami strategi digital secara utuh. Sekarang saya melihat mereka lebih seperti partner digital marketing organik yang benar-benar membantu perkembangan bisnis, bukan vendor teknis semata. Terima kasih Portal Online atas kerjasamanya, semoga ke depan semakin banyak pelaku usaha yang terbantu dan merasakan manfaat yang sama seperti saya.",
        rating: 5,
    },
];
---

<section class="section testi-section">
    <div class="container">
        <!-- Header -->
        <div class="testi-header">
            <h2 class="section-title">
                Testimoni <span class="text-gradient">Klien Kami</span>
            </h2>
            <p class="section-subtitle">
                Kami tidak mengarang testimoni, anda bisa konfirmasi langsung ke klien kami.
            </p>
        </div>

        <!-- Two-Column Carousel -->
        <div class="testi-grid">

            <!-- Left: Stacked avatar cards (hidden on mobile, shown on lg) -->
            <div class="avatar-col">
                <div class="avatar-stack">
                    {testimonials.map((item, index) => (
                        <div
                            class="av-card"
                            data-index={index}
                            style={
                                index === 0
                                    ? "transform:translateX(0) rotate(0deg) scale(1);opacity:1;z-index:30;"
                                    : index === 1
                                    ? "transform:translateX(-22px) translateY(10px) rotate(-9deg) scale(0.92);opacity:0.65;z-index:20;"
                                    : "transform:translateX(22px) translateY(14px) rotate(9deg) scale(0.87);opacity:0.4;z-index:10;"
                            }
                        >
                            <img
                                src={item.avatar}
                                alt={item.name}
                                loading="lazy"
                                decoding="async"
                            />
                            <div class="av-overlay" />
                        </div>
                    ))}
                </div>
            </div>

            <!-- Right: Testimonial card -->
            <div class="content-col">
                <div class="testi-card">
                    <!-- Decorative huge quote -->
                    <div class="deco-quote" aria-hidden="true">
                        <svg width="72" height="72" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10H14.017zM0 21v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151C7.563 6.068 6 8.789 6 11h4v10H0z"/>
                        </svg>
                    </div>

                    <!-- Stars -->
                    <div class="stars-row">
                        {[...Array(5)].map(() => (
                            <svg width="18" height="18" viewBox="0 0 20 20" fill="#f59e0b">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        ))}
                    </div>

                    <!-- Text slides wrapper -->
                    <div class="text-wrap">
                        {testimonials.map((item, index) => (
                            <div
                                class="text-slide"
                                data-slide={index}
                                style={index === 0 ? "position:relative;opacity:1;transform:translateY(0);" : "position:absolute;opacity:0;transform:translateY(16px);pointer-events:none;"}
                            >
                                <p class="testi-text">&ldquo;{item.content}&rdquo;</p>
                            </div>
                        ))}
                    </div>

                    <!-- Divider -->
                    <div class="testi-divider" />

                    <!-- Author slides wrapper -->
                    <div class="author-wrap">
                        {testimonials.map((item, index) => (
                            <div
                                class="author-slide"
                                data-author={index}
                                style={index === 0 ? "position:relative;opacity:1;transform:translateY(0);" : "position:absolute;opacity:0;transform:translateY(16px);pointer-events:none;"}
                            >
                                <!-- Small avatar (shows on mobile where left col is hidden) -->
                                <div class="author-avatar-sm">
                                    <img src={item.avatar} alt={item.name} />
                                </div>
                                <div>
                                    <p class="author-name">{item.name}</p>
                                    <p class="author-role">{item.role}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    <!-- Navigation -->
                    <div class="nav-row">
                        <button class="nav-btn testi-prev" aria-label="Testimoni sebelumnya">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button class="nav-btn testi-next" aria-label="Testimoni berikutnya">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        <div class="dots-row">
                            {testimonials.map((_, index) => (
                                <button
                                    class={`dot testi-dot${index === 0 ? " dot-active" : ""}`}
                                    data-dot={index}
                                    aria-label={`Testimoni ${index + 1}`}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* ── Layout ── */
    .testi-section {
        position: relative;
    }

    .testi-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .testi-header .badge {
        margin-bottom: 1rem;
    }

    .testi-header .section-subtitle {
        margin: 0.75rem auto 0;
    }

    .testi-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        align-items: center;
        opacity: 0;
        transform: translateY(28px);
        animation: testiEnter 0.75s cubic-bezier(0.22, 1, 0.36, 1) 0.15s forwards;
    }

    @media (min-width: 1024px) {
        .testi-grid {
            grid-template-columns: 1fr 3fr;
            gap: 3rem;
        }
    }

    @keyframes testiEnter {
        to { opacity: 1; transform: translateY(0); }
    }

    /* ── Left: Avatar Stack ── */
    .avatar-col {
        display: none;
    }

    @media (min-width: 1024px) {
        .avatar-col {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
    }

    .avatar-stack {
        position: relative;
        width: 17rem;
        height: 21rem;
        flex-shrink: 0;
    }

    .av-card {
        position: absolute;
        inset: 0;
        border-radius: 1.25rem;
        overflow: hidden;
        border: 2.5px solid rgba(255, 255, 255, 0.35);
        box-shadow: 0 20px 48px -12px rgba(0, 0, 0, 0.22);
        transition:
            transform 0.65s cubic-bezier(0.22, 1, 0.36, 1),
            opacity 0.65s cubic-bezier(0.22, 1, 0.36, 1),
            box-shadow 0.5s ease;
    }

    .av-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .av-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.18) 0%, transparent 55%);
        pointer-events: none;
    }

    /* ── Right: Testimonial Card ── */
    .content-col {
        width: 100%;
        min-width: 0;
    }

    .testi-card {
        position: relative;
        padding: 2rem 2rem 1.75rem;
        background: var(--color-surface, #ffffff);
        border: 1px solid var(--color-border, rgba(255,255,255,0.12));
        border-radius: 1.5rem;
        box-shadow:
            0 4px 6px rgba(0,0,0,0.04),
            0 10px 15px rgba(0,0,0,0.04);
        overflow: hidden;
    }

    /* Inject a solid fallback background in case surface is transparent */
    @media (prefers-color-scheme: dark) {
        .testi-card {
            background: var(--color-surface, #1a1a2e);
        }
    }

    /* Decorative quote */
    .deco-quote {
        position: absolute;
        top: 1rem;
        right: 1.25rem;
        opacity: 0.05;
        pointer-events: none;
        color: var(--color-text, #000);
    }

    /* Stars */
    .stars-row {
        display: flex;
        gap: 3px;
        margin-bottom: 1.25rem;
        line-height: 0;
    }

    /* Text area */
    .text-wrap {
        position: relative;
        min-height: 7.5rem;
        margin-bottom: 1.5rem;
    }

    .text-slide {
        top: 0;
        left: 0;
        right: 0;
        transition:
            transform 0.5s cubic-bezier(0.22, 1, 0.36, 1),
            opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .testi-text {
        font-size: 1rem;
        line-height: 1.8;
        color: var(--color-text-muted);
        font-style: italic;
        margin: 0;
    }

    /* Divider */
    .testi-divider {
        width: 3rem;
        height: 2px;
        border-radius: 9999px;
        background: var(--color-primary, #e53935);
        margin-bottom: 1.25rem;
    }

    /* Author area */
    .author-wrap {
        position: relative;
        min-height: 3.5rem;
        margin-bottom: 1.5rem;
    }

    .author-slide {
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition:
            transform 0.5s cubic-bezier(0.22, 1, 0.36, 1),
            opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .author-avatar-sm {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        border: 2px solid var(--color-border, rgba(255,255,255,0.2));
    }

    .author-avatar-sm img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    @media (min-width: 1024px) {
        .author-avatar-sm {
            display: none;
        }
    }

    .author-name {
        font-family: var(--font-display);
        font-size: 1.0625rem;
        font-weight: 700;
        color: var(--color-text);
        margin: 0 0 0.125rem;
    }

    .author-role {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--color-primary, #e53935);
        margin: 0;
    }

    /* Navigation */
    .nav-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        border: 1px solid var(--color-border, rgba(255,255,255,0.15));
        background: transparent;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: background 0.2s, color 0.2s, transform 0.15s;
        flex-shrink: 0;
    }

    .nav-btn:hover {
        background: var(--color-bg-tertiary, rgba(255,255,255,0.08));
        color: var(--color-text);
    }

    .nav-btn:active {
        transform: scale(0.9);
    }

    /* Dots */
    .dots-row {
        display: flex;
        align-items: center;
        gap: 0;
        margin-left: 0.25rem;
    }

    .dot {
        width: 48px;
        height: 48px;
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .dot::after {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 9999px;
        background: var(--color-border, rgba(255,255,255,0.2));
        transition: width 0.3s, background-color 0.3s;
    }

    .dot-active::after,
    .dot[data-active="true"]::after {
        width: 1.5rem;
        background: var(--color-primary, #e53935);
    }
</style>

<script>
    function initTestimonials() {
        // Scope to THIS section, not global document
        const section = document.querySelector<HTMLElement>(".testi-section");
        if (!section) return;

        const avCards    = Array.from(section.querySelectorAll<HTMLElement>(".av-card"));
        const txtSlides  = Array.from(section.querySelectorAll<HTMLElement>(".text-slide"));
        const authSlides = Array.from(section.querySelectorAll<HTMLElement>(".author-slide"));
        const dots       = Array.from(section.querySelectorAll<HTMLElement>(".testi-dot"));
        const prevBtn    = section.querySelector<HTMLElement>(".testi-prev");
        const nextBtn    = section.querySelector<HTMLElement>(".testi-next");
        const grid       = section.querySelector<HTMLElement>(".testi-grid");

        const total = avCards.length;
        if (total === 0) return;

        let cur = 0;
        let busy = false;
        let timer: ReturnType<typeof setInterval>;

        /* ── avatar card positioning ── */
        function positionCards(active: number) {
            avCards.forEach((card, i) => {
                const diff = (i - active + total) % total;
                if (diff === 0) {
                    card.style.cssText = "position:absolute;inset:0;transform:translateX(0) rotate(0deg) scale(1);opacity:1;z-index:30;transition:transform .65s cubic-bezier(.22,1,.36,1),opacity .65s cubic-bezier(.22,1,.36,1);";
                } else if (diff === total - 1) {
                    card.style.cssText = "position:absolute;inset:0;transform:translateX(-22px) translateY(10px) rotate(-9deg) scale(0.92);opacity:0.65;z-index:20;transition:transform .65s cubic-bezier(.22,1,.36,1),opacity .65s cubic-bezier(.22,1,.36,1);";
                } else if (diff === 1) {
                    card.style.cssText = "position:absolute;inset:0;transform:translateX(22px) translateY(14px) rotate(9deg) scale(0.87);opacity:0.4;z-index:10;transition:transform .65s cubic-bezier(.22,1,.36,1),opacity .65s cubic-bezier(.22,1,.36,1);";
                } else {
                    card.style.cssText = "position:absolute;inset:0;transform:scale(0.8);opacity:0;z-index:0;pointer-events:none;transition:transform .65s cubic-bezier(.22,1,.36,1),opacity .65s cubic-bezier(.22,1,.36,1);";
                }
            });
        }

        const TRANS = "transition:transform .5s cubic-bezier(.22,1,.36,1),opacity .5s cubic-bezier(.22,1,.36,1);";

        function slideIn(el: HTMLElement, fromBelow: boolean) {
            const start = fromBelow ? "translateY(16px)" : "translateY(-16px)";
            el.style.cssText = `position:absolute;top:0;left:0;right:0;display:flex;align-items:center;gap:.75rem;opacity:0;transform:${start};pointer-events:none;${TRANS}`;
            requestAnimationFrame(() => requestAnimationFrame(() => {
                el.style.cssText = `position:relative;opacity:1;transform:translateY(0);display:flex;align-items:center;gap:.75rem;${TRANS}`;
            }));
        }

        function slideOut(el: HTMLElement, toUp: boolean) {
            const end = toUp ? "translateY(-16px)" : "translateY(16px)";
            el.style.cssText = `position:absolute;top:0;left:0;right:0;display:flex;align-items:center;gap:.75rem;opacity:0;transform:${end};pointer-events:none;${TRANS}`;
        }

        function slideInText(el: HTMLElement, fromBelow: boolean) {
            const start = fromBelow ? "translateY(16px)" : "translateY(-16px)";
            el.style.cssText = `position:absolute;top:0;left:0;right:0;opacity:0;transform:${start};pointer-events:none;${TRANS}`;
            requestAnimationFrame(() => requestAnimationFrame(() => {
                el.style.cssText = `position:relative;opacity:1;transform:translateY(0);${TRANS}`;
            }));
        }

        function slideOutText(el: HTMLElement, toUp: boolean) {
            const end = toUp ? "translateY(-16px)" : "translateY(16px)";
            el.style.cssText = `position:absolute;top:0;left:0;right:0;opacity:0;transform:${end};pointer-events:none;${TRANS}`;
        }

        function updateDots(active: number) {
            dots.forEach((d, i) => {
                d.dataset.active = (i === active).toString();
                if (i === active) d.classList.add("dot-active");
                else d.classList.remove("dot-active");
            });
        }

        function goTo(next: number, dir: "next" | "prev") {
            if (busy || next === cur) return;
            busy = true;
            const goingNext = dir === "next";
            txtSlides.forEach((slide, i) => {
                if (i === next) slideInText(slide, goingNext);
                else if (i === cur) slideOutText(slide, goingNext);
            });
            authSlides.forEach((slide, i) => {
                if (i === next) slideIn(slide, goingNext);
                else if (i === cur) slideOut(slide, goingNext);
            });
            positionCards(next);
            updateDots(next);
            cur = next;
            setTimeout(() => { busy = false; }, 650);
        }

        const goNext = () => goTo((cur + 1) % total, "next");
        const goPrev = () => goTo((cur - 1 + total) % total, "prev");

        // Init
        positionCards(0);
        txtSlides.forEach((s, i) => {
            s.style.cssText = i === 0
                ? "position:relative;opacity:1;transform:translateY(0);"
                : "position:absolute;top:0;left:0;right:0;opacity:0;transform:translateY(16px);pointer-events:none;";
        });
        authSlides.forEach((s, i) => {
            s.style.cssText = i === 0
                ? "position:relative;opacity:1;transform:translateY(0);display:flex;align-items:center;gap:.75rem;"
                : "position:absolute;top:0;left:0;right:0;opacity:0;transform:translateY(16px);pointer-events:none;display:flex;align-items:center;gap:.75rem;";
        });
        updateDots(0);

        prevBtn?.addEventListener("click", goPrev);
        nextBtn?.addEventListener("click", goNext);

        dots.forEach((dot, i) => {
            dot.addEventListener("click", () => {
                if (i === cur) return;
                goTo(i, i > cur ? "next" : "prev");
            });
        });

        // Keyboard (scoped: only run when section is visible in viewport)
        function onKey(e: KeyboardEvent) {
            const rect = section!.getBoundingClientRect();
            const visible = rect.top < window.innerHeight && rect.bottom > 0;
            if (!visible) return;
            if (e.key === "ArrowRight") goNext();
            if (e.key === "ArrowLeft") goPrev();
        }
        document.addEventListener("keydown", onKey);

        // Swipe
        let sx = 0;
        grid?.addEventListener("touchstart", (e) => { sx = (e as TouchEvent).changedTouches[0].screenX; }, { passive: true });
        grid?.addEventListener("touchend", (e) => {
            const diff = sx - (e as TouchEvent).changedTouches[0].screenX;
            if (Math.abs(diff) > 50) diff > 0 ? goNext() : goPrev();
        }, { passive: true });

        // Auto-scroll
        const startAuto = () => { timer = setInterval(goNext, 5000); };
        const stopAuto  = () => clearInterval(timer);

        startAuto();
        grid?.addEventListener("mouseenter", stopAuto);
        grid?.addEventListener("mouseleave", startAuto);
        grid?.addEventListener("touchstart", stopAuto, { passive: true });
        grid?.addEventListener("touchend",   startAuto, { passive: true });

        // Cleanup on Astro page leave
        document.addEventListener("astro:before-preparation", () => {
            stopAuto();
            document.removeEventListener("keydown", onKey);
        }, { once: true });
    }

    // Run on first load AND on every Astro View Transition navigation
    document.addEventListener("astro:page-load", initTestimonials);
</script>

